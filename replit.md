# A.Z Finance Hub

## Overview
A.Z Finance Hub is a personal investment management platform for tracking and analyzing Sharia-compliant investments, specifically Sukuk-based portfolios and crowdfunding debt platforms (Sukuk, Manfa'a, Lendo). It provides comprehensive portfolio tracking, cashflow management, and analytics to help users achieve financial independence aligned with Saudi Arabia's Vision 2040. The platform is designed as a single-user tool to ensure simplicity and focus on Sharia-compliant financial management.

## User Preferences
- Default theme: Dark mode
- Default language: English (supports Arabic)
- Currency: SAR (Saudi Riyal)
- Date format: en-US locale
- **Number Format:** All numbers display in English digits (0-9) across both English and Arabic interfaces, using `Intl.NumberFormat('en-US')` consistently throughout the application
- Layout Direction: **Permanent RTL** - Application uses right-to-left layout for both English and Arabic, optimized for right-hand mobile usage
- Mobile Optimized: Full responsive design for all screen sizes (mobile, tablet, desktop)
- **Mobile Gesture Navigation:** Swipe from right edge (>50px from edge) to left on mobile devices to open sidebar navigation

## System Architecture
The application is a single-user personal tool built with a modern web stack, operating without authentication.

**UI/UX Decisions:**
- **Dashboard:** Simplified "Classic View" with compact financial metric cards and platform overview. A "Pro mode" toggle offers advanced features.
- **Investment Management:** Investments are displayed in a horizontal row-based layout for desktop and a stacked vertical layout for mobile, with status-based color coding, payment progress indicators, and real-time ROI calculations.
- **Unified Cashflows Interface:** A single integrated page (`/cashflows`) merges Investment Cashflows and Cash Management with three tabs: All Transactions, Investment Cashflows (with interactive payment schedule), and Cash Transactions. It features a combined statistics dashboard.
- **Analytics:** Includes monthly returns trends, platform allocation with interactive three-mode switching (All Value/Active Value/Count), and performance comparisons against Vision 2040 targets, separating principal from profit.
- **Alerts System:** Smart, user-configurable alerts with severity classification.
- **Platform Management:** Dedicated pages for platform details, statistics, and filtered investment lists. Settings page includes full platform CRUD operations: create new platforms, edit platform names (with dialog-based UI and validation), and delete platforms (with investment-linkage checks). Edit functionality validates non-empty names on both frontend and backend.
- **Vision 2040 Progress Calculator:** Simplified unified interface at `/vision-2040` featuring a single integrated chart with three trajectory lines: Blue (current projection), Green (adaptive target from VisionTarget records), and Orange (historical actuals from PortfolioHistory). Includes editable calculation inputs, historical data table, and full responsive design. **Complete bilingual support (English/Arabic)** with 29 translation keys covering all UI elements: tabs (Overview/Progress/Targets), buttons, table headers, chart labels, source badges (manual/generated/auto), time indicators, status messages, error messages, and user-facing copy. Target capital field uses local state buffering with blur-save pattern to prevent data corruption. **Compact spacing design** with reduced padding and margins for optimal space utilization while maintaining readability (pb-4→pb-2, space-y-6→space-y-4, gap-4→gap-3).
- **Reports System:** Comprehensive financial reporting with Excel (XLSX) and PDF export, customizable date ranges, and platform filtering. **Independent Report Language Selection:** Separate language picker (English/Arabic) for report exports, independent of UI language setting. **Full Bilingual PDF Export:** PDF exports now support both English and Arabic with Noto Sans Arabic font (174KB, dynamically loaded from `/fonts/NotoSansArabic.ttf`), RTL text alignment (`x=pageWidth-15, {align: 'right'}`), and bidirectional table formatting via jsPDF autoTable (`halign: 'right'`). Error handling includes graceful fallback to English PDF when font loading fails. **Complete Bilingual Translation System:** 77 report.* translation keys covering all UI elements, metrics, enum values (investment statuses: active/completed/late/defaulted/pending, cashflow statuses: received/expected/upcoming, cashflow types: principal/profit, frequencies: monthly/quarterly/semi_annually/annually/at_maturity/custom). Platform names and investment names remain in original language (not translated). System uses `translateValue()` helper for schema enum translation with full coverage of shared/schema.ts enum literals.

**Technical Implementations & Design Choices:**
- **Frontend:** React, TypeScript, Tailwind CSS, Shadcn UI, Recharts, Wouter, TanStack Query.
- **Backend:** Express.js and Node.js.
- **Styling:** Tailwind CSS with custom design tokens, dark/light mode, and full bilingual support (English/Arabic) with RTL typography.
- **Performance Optimizations:** Code splitting with React.lazy() for all pages (Dashboard, Reports, Vision2040, Investments, etc.), Suspense boundaries with loading states, and optimized component re-renders.
- **Error Handling:** Global ErrorBoundary component wrapping the entire app with user-friendly error recovery UI and automatic navigation to dashboard.
- **Code Quality:** Clean codebase with minimal console.log usage (dev-only), organized imports, and production-ready error handling.
- **Progressive Web App (PWA):** Full PWA support enabling installation on desktop and mobile devices. Features versioned service worker (v1.0.0) with intelligent caching strategies: static cache for HTML/manifest/icons, runtime cache for JS/CSS/fonts/images (cache-first with background update), and network-only for all API routes to prevent stale financial data. Includes PWA manifest with branded icons (192px, 512px), theme color integration, Apple-specific meta tags, and offline navigation fallback. **Cache Update Procedure:** Increment `CACHE_VERSION` constant in `client/public/sw.js` when deploying updates to trigger automatic cache invalidation and ensure users receive latest assets.
- **Number Formatting:** Unified `Intl.NumberFormat('en-US')` across all components ensures consistent English digit display (0-9) in both English and Arabic interfaces, applied to currency values, percentages, dates, and all numeric displays throughout the application.
- **Mobile Swipe Gesture Navigation:** Custom `useSwipeGesture` hook enables touch-based sidebar navigation on mobile devices. Detects swipes from right edge (threshold: 50px) with minimum swipe distance of 50px. Filters out vertical scrolls and only activates on mobile devices (breakpoint: <768px). Integrates seamlessly with Shadcn sidebar system using touch events (touchstart, touchmove, touchend).
- **Design System Unification:** Standardized reusable primitives, consistent spacing, typography, card padding, grid gaps, icon sizing, and motion variants across all pages and components.
- **Mobile Chart Optimization:** Universal edge-to-edge chart pattern for optimal mobile viewing across all chart components, with self-contained responsive patterns and optimized heights.
- **Cashflow Forecast Chart Redesign:** Rebuilt as a horizontal stacked bar chart for enhanced readability of 40-month forecasts, separating principal and profit. Features inline numeric labels, dynamic height calculation, and mobile edge-to-edge rendering.
- **Financial Metrics System:** Comprehensive utilities for calculating portfolio value, cash ratio, investment returns (profit-only ROI), APR, and statistical analysis, respecting Sukuk structure.
- **Three-Mode Platform Distribution System:** Interactive chart system allowing users to view platform allocation in three distinct modes: (1) All Value - all investments by value with percentages summing to 100%, (2) Active Value - active investments only by value, (3) Count - all investments by count. Features click-to-cycle mode switching, localStorage persistence, mode indicator badge, and full bilingual support (English/Arabic).
- **Platform Color System:** Centralized platform-specific color definitions in `lib/platform-colors.ts` ensuring consistent visual identity across badges, borders, and charts. Platform-specific colors: Sukuk (light gray #E5E7EB), Manfa'a (black #1F2937), Dinar (sky blue #38BDF8), Safqa (yellow #FACC15), Tarmeez (green #22C55E), Ta'meed (blue #2563EB). Chart components (`PlatformDistributionChart`, `CombinedChartsCard`) use `getPlatformChartColor()` with smart fallback to rotating palette colors for unknown platforms, ensuring all platforms have distinct, visible colors in both light and dark themes.
- **Smart Pie Chart Label System:** Intelligent label positioning for platform distribution charts with 15% threshold-based positioning. Large slices (>15%) display labels inside with white text and shadow for contrast, while small slices (<15%) show labels outside with connector lines and dynamic text alignment (start/end based on position). Outside labels positioned at 50px distance from pie edge with additional horizontal offset (±8px) to prevent text touching slice edges. Custom `labelLine` renderer conditionally renders polyline connectors only for small slices, properly converting point coordinates to SVG strings. All pie chart slices feature visible stroke borders (1.5px, theme-aware border color) for clear segment separation. **Responsive chart sizing:** Charts use `max-w-[170px] aspect-square` with 170px maximum size on larger screens, outerRadius of 65. **Grid layout:** `grid-cols-2` displays charts side-by-side on all screen sizes. Applied consistently to both `CombinedChartsCard` and `PlatformDistributionChart` components.
- **Core Entities:** Platforms, Investments, Cashflows, CashTransactions, Alerts, UserSettings, PortfolioStats, AnalyticsData, SavedScenarios.
- **Cache Management:** App-level version tracking, `refetchOnMount: true` for investments, global `staleTime: Infinity` for offline support, and targeted `refetchQueries` for efficient cache updates.
- **Smart Sukuk Cashflow System:** Intelligent automatic cashflow generation system that understands Sukuk structure, supports flexible profit payment schedules, and generates smart payment distributions based on frequency.
- **Custom Distribution Scheduling:** Production-ready backend system for manual cashflow scheduling with irregular payment patterns, offering CRUD support, transaction-safe operations, and comprehensive validation.
- **Automatic Investment Status Management:** Background task system for hourly status transitions (Active → Late → Defaulted → Completed), with centralized configuration, optimized cashflow grouping, and transaction-wrapped database updates.
- **Late Status Management System:** Comprehensive late payment handling with a dedicated dialog offering three reconciliation options: clear late status, keep unchanged, or update late days manually.
- **Atomic Cash Transaction Automation System:** Production-ready automatic cash movement tracking integrated throughout the investment lifecycle with three-layer protection for `createInvestment`, `updateCashflow`, and `completeAllPendingPayments`. All operations are wrapped in `db.transaction()` for ACID compliance.
- **Cash Balance Calculation:** Platform-specific balance aggregation using signed CASE logic, supporting legacy transactions via investment linkage.
- **Portfolio Checkpoint System:** Full snapshot backup/restore functionality, allowing users to save and restore complete portfolio states with metadata tracking, using transaction-safe operations.

- **Data-Entry Sharing System:** Secure token-based system allowing external users to manage investments while restricting access to sensitive financial data. Implemented with backend middleware (`withDataEntryToken`, `blockDataEntry`), client-side token verification, and dedicated `/data-entry/:token` page. Data-entry users have full CRUD on investments/cashflows only, blocked from dashboard stats, reports, cash transactions, settings, and platform management. InvestmentDialog component enhanced with optional `dataEntryToken` prop that includes X-Data-Entry-Token header in create/update mutations when present. **Security Note:** System designed for single-user application with private hosting; owner access assumed when no X-Data-Entry-Token header present.

## External Dependencies
- **Charting:** Recharts for data visualization.
- **Database:** PostgreSQL (via Neon) with Drizzle ORM.