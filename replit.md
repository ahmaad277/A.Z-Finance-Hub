# A.Z Finance Hub

## Overview
A.Z Finance Hub is a personal investment management platform designed for tracking and analyzing Sharia-compliant investments, specifically Sukuk-based portfolios and crowdfunding debt platforms (Sukuk, Manfa'a, Lendo). Its core purpose is to provide comprehensive portfolio tracking, cashflow management, and analytics to help users achieve financial independence aligned with Saudi Arabia's Vision 2040. The platform is built as a single-user tool to ensure simplicity and reduce operational overhead, offering a focused approach to Sharia-compliant financial management.

## User Preferences
- Default theme: Dark mode
- Default language: English (supports Arabic)
- Currency: SAR (Saudi Riyal)
- Date format: en-US locale
- Layout Direction: **Permanent RTL** - Application uses right-to-left layout for both English and Arabic, optimized for right-hand mobile usage
- Mobile Optimized: Full responsive design for all screen sizes (mobile, tablet, desktop)

## System Architecture
The application is a single-user personal tool built with a modern web stack, operating without authentication.

**UI/UX Decisions:**
-   **Dashboard:** Features a "Classic View" with compact financial metric cards, platform overview, portfolio performance charts, upcoming cashflows, and recent investments. A "Pro mode" toggle offers advanced features.
-   **Investment Management:** Investments are displayed in a horizontal row-based layout for desktop and a stacked vertical layout for mobile, with status-based color coding, payment progress indicators, platform categorization, risk scoring, and real-time ROI calculations. An ultra-compact 40px investment row view is available for mobile, displaying essential metrics and opening a detailed drawer on click.
-   **Unified Cashflows Interface:** A single integrated page (route: /cashflows) merging Investment Cashflows and Cash Management with three tabs: (1) All Transactions - unified view combining both cashflows and cash transactions chronologically, (2) Investment Cashflows - dedicated view for cashflow tracking with status indicators and distribution type tracking, including an interactive, color-coded payment schedule system, (3) Cash Transactions - dedicated view for cash management with transaction filtering and balance tracking. The page features combined statistics dashboard showing total received, expected cashflows, available balance, deposits, withdrawals, and investments.
-   **Analytics:** Includes monthly returns trends, platform allocation pie charts, and performance comparisons against Vision 2040 targets. All analytics are designed to respect Sukuk structure by separating principal from profit.
-   **Alerts System:** Smart, user-configurable alerts with severity classification.
-   **Platform Management:** Dedicated pages for platform details, statistics, and filtered investment lists.
-   **Vision 2040 Progress Calculator:** A unified component (Vision2040Calculator) merging goal planning with progress tracking. Features dual progress bars (current portfolio path vs. test scenarios), interactive timeline (2025-2040), smart indicators (progress %, completion date, monthly gap, required return), saved scenarios management (max 5 scenarios per user stored in saved_scenarios table), and full portfolio integration using weighted APR calculations. Replaced legacy Goal Calculator and Vision 2040 Progress Widget to eliminate duplication.
-   **Smart Payment Processing:** Enhanced dialog for investment completion with automatic date confirmation and ROI calculation.
-   **Reports System:** Comprehensive financial reporting with Excel (XLSX) and PDF export, customizable date ranges, and platform filtering.

**Technical Implementations & Design Choices:**
-   **Frontend:** React, TypeScript, Tailwind CSS, Shadcn UI, Recharts, Wouter, TanStack Query.
-   **Backend:** Express.js and Node.js.
-   **Styling:** Tailwind CSS with custom design tokens, dark/light mode, and full bilingual support (English/Arabic) with RTL typography.
-   **Design System Unification (Nov 2025):** Comprehensive design system standardization across all pages and components featuring: (1) Reusable primitives (PageHeader, PageSection) with consistent spacing (space-y-4 sm:space-y-6), typography hierarchy (text-2xl/xl/lg), and 200ms animations; (2) Unified card padding (p-6) and grid gaps (gap-4 sm:gap-6) throughout application; (3) Standardized icon sizing (h-4 w-4 small, h-5 w-5 medium, h-6 w-6 large); (4) Motion variants system (motion-variants.ts) for consistent fade/slide/scale animations; (5) Design compliance fixes removing border-l-4 from rounded cards and ensuring proper hover/active states. All 10+ pages (Dashboard, Investments, Reports, Alerts, Reinvestment, Settings, Help, Platform Details) and shared components (FinancialMetricsOnly, PlatformCard) now follow unified design standards with architect-approved implementation.
-   **Mobile Chart Optimization (Nov 2025):** Universal edge-to-edge chart pattern for optimal mobile viewing across all 5 chart components (CashflowForecastChart, PortfolioChart, MonthlyReturnsChart, PerformanceVsTargetChart, PlatformAllocationChart). Features: (1) Self-contained responsive pattern - each chart component manages its own desktop padding wrapper (`<div className="px-6 pb-6">`) and mobile edge-to-edge container (`<div className="w-full overflow-x-auto sm:hidden -mx-6 px-6">`); (2) Reduced mobile heights: Bar/Line charts use 200px height with horizontal scroll (minWidth=600-800px) for 40-month datasets, Pie charts use 300px height; (3) Desktop heights optimized per chart type (300-600px); (4) Consistent responsive breakpoints (sm:640px) with `hidden sm:block` for desktop, `sm:hidden` for mobile; (5) Parent pages (Dashboard, Analytics) use `CardContent className="p-0"` with no redundant wrappers, ensuring charts span full width on mobile from far-left to far-right edge; (6) Chart margins optimized for each viewport (desktop: right=0, left=0; mobile: right=10, left=10). Pattern ensures professional, space-efficient displays on mobile devices while maintaining desktop aesthetics.
-   **Cashflow Forecast Chart Redesign (Nov 2025):** Complete rebuild from vertical bar chart to horizontal stacked bar chart for enhanced readability of 40-month forecasts. Features: (1) Horizontal layout with Recharts `layout="vertical"` displaying month labels on Y-axis in format "(1) Nov-25", "(2) Dec-25", ... "(40)"; (2) Stacked bars separating principal (القيمة الاسمية) using `hsl(var(--chart-4))` color and profit (الربح) using `hsl(var(--chart-2))` color; (3) Inline numeric labels using LabelList with compact formatting (K for thousands, M for millions) appearing inside bars when width >= 40px; (4) Dynamic height calculation (32px per month row, minimum 400px) ensuring all 40 months display comfortably; (5) YAxis as category type with 110px width for month labels, XAxis as number type for currency values; (6) Enhanced tooltip showing principal, profit, and total with proper formatting; (7) Responsive behavior: desktop uses standard padding, mobile uses dual-axis scroll with maxHeight=600px for optimal navigation through 40 rows. Implementation uses shared/cashflow-forecast.ts for data calculation and maintains bilingual support (English/Arabic) throughout.
-   **Financial Metrics System:** Comprehensive utilities for calculating portfolio value, cash ratio, investment returns (profit-only ROI), APR, statistical analysis, and tracking late/defaulted investments. Includes Weighted APR and Portfolio ROI calculations that respect Sukuk structure (capital vs. profit separation).
-   **Core Entities:** Platforms, Investments, Cashflows, CashTransactions, Alerts, UserSettings, PortfolioStats, AnalyticsData, SavedScenarios.
-   **Cache Management:** App-level version tracking clears localStorage cache on version mismatch. Investment query uses `refetchOnMount: true` to ensure fresh data on navigation, while global `staleTime: Infinity` preserves offline cache support. Mutation callbacks use targeted `refetchQueries({ queryKey: ['specific-endpoint'], type: 'all' })` to force cache updates for specific resources even when data considered fresh, avoiding unnecessary global refetch overhead.
-   **Smart Sukuk Cashflow System:** Features an intelligent automatic cashflow generation system that understands Sukuk structure (faceValue + totalExpectedProfit), supports flexible profit payment schedules (periodic vs. at_maturity), and generates smart payment distributions based on frequency (monthly, quarterly, semi_annually, annually, at_maturity). The system includes `shared/cashflow-generator.ts` and enhanced schema with `faceValue`, `totalExpectedProfit`, `profitPaymentStructure` fields. Frontend components (Investment Dialog, Investment Cards, Payment Schedule Manager, Dashboard Metrics, Analytics) are fully integrated to reflect Sukuk-native calculations and displays, accurately separating principal from profit.
-   **Custom Distribution Scheduling:** Production-ready backend system for manual cashflow scheduling when investments have irregular payment patterns. Features: (1) `custom_distributions` table with full CRUD support via `customDistributions` API parameter; (2) Transaction-safe create/update operations with preserve/clear/replace logic (undefined=preserve existing, []=clear & regenerate, non-empty=replace); (3) Comprehensive validation requiring custom schedules when frequency='custom', enforcing positive amounts and date-range validation (startDate/endDate required for PATCH with custom distributions); (4) Automatic matching cashflow generation from custom distribution records; (5) Historical data preservation (received cashflows never deleted during updates); (6) `CustomCashflowEditor` component for adding/removing distribution rows with real-time totals. **Status:** Backend complete and architect-approved, frontend edit mode (hydrating existing custom distributions) deferred for future implementation.
-   **Automatic Investment Status Management:** Background task system with hourly periodic checks for status transitions (Active → Late → Defaulted → Completed). Features centralized status configuration utility (`shared/status-manager.ts`), optimized O(n) cashflow grouping, transaction-wrapped database updates with `lateDate`/`defaultedDate` tracking, and bilingual status display with distinct color schemes across all UI components.
-   **Late Status Management System:** Comprehensive late payment handling with LateStatusDialog component offering three reconciliation options when marking late/defaulted payments as received: (1) Clear late status - removes late/defaulted dates and triggers automatic status recalculation, (2) Keep status unchanged - preserves existing late/defaulted state, (3) Update late days manually - allows custom late day adjustment. Features enhanced PATCH /api/cashflows/:id validation with z.coerce.date() for receivedDate (fixes Drizzle ORM toISOString serialization errors), .strict() enforcement for updateLateInfo requiring positive lateDays, and .refine() checks preventing contradictory payloads. Integrated into both compact investment row and details drawer workflows with automatic cash transaction creation.
-   **Cash Balance Calculation:** Implemented sum aggregation across all transactions for accurate cash balance.
-   **Portfolio Checkpoint System:** Full snapshot backup/restore functionality allowing users to save complete portfolio state (investments, cashflows, transactions, platforms, alerts, scenarios, settings) with metadata tracking (entity counts, byte size). Features: (1) `portfolio_snapshots` table with UUID id, name, snapshotData (JSONB), entityCounts (JSONB), byteSize, createdAt; (2) SaveCheckpointButton in global header for quick saves; (3) CheckpointsManager in Settings page for browsing, restoring, and deleting snapshots; (4) Transaction-safe restore operations that atomically replace all portfolio data; (5) Full bilingual support with descriptive dialogs and toasts. Storage methods use transactions to guarantee data consistency during capture and restore.

## External Dependencies
-   **Charting:** Recharts for data visualization.
-   **Database:** Currently uses in-memory storage (MemStorage).